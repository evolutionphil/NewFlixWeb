<style>
    .filter-wrapper label{
        color:#fff !important;
    }
</style>
<div class="page-content">
    <div class="panel panel-boxed">
        <div class="panel-heading">
            <h3 class="panel-title">Play Lists</h3>
        </div>
        <div class="panel-body">
            <div class="list-container">
                <div class="filter-wrapper">
                    <div class="select-country-wrapper">
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_android" checked>
                            <label for="show_android">Show Android</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_samsung" checked>
                            <label for="show_samsung">Show Samsung</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_lg" checked>
                            <label for="show_lg">Show Lg</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_ios" checked>
                            <label for="show_ios">Show iOS</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_tvOS" checked>
                            <label for="show_tvOS">Show tvOS</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_macOS" checked>
                            <label for="show_macOS">Show macOS</label>
                        </div>
                        <h4 class="example-title"
                            style="color:#fff;margin-top:20px"
                        >
                            Filter by activated status
                        </h4>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_activated" checked>
                            <label for="show_activated">Show Activate</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_trial" checked>
                            <label for="show_trial">Show Trial</label>
                        </div>
                        <h4 class="example-title"
                            style="color:#fff;margin-top:20px"
                        >
                            Filter by creation date
                        </h4>
                        <div class="form-group">
                            <select id="date_filter" class="form-control" style="background-color:#1e293b;color:#fff;border:1px solid #3e4651;">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="last_week">Last 7 Days</option>
                                <option value="last_month">Last 30 Days</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div id="custom_date_range" style="display:none;">
                            <div class="form-group">
                                <label style="color:#fff;">From Date:</label>
                                <input type="date" id="date_from" class="form-control" style="background-color:#1e293b;color:#fff;border:1px solid #3e4651;">
                            </div>
                            <div class="form-group">
                                <label style="color:#fff;">To Date:</label>
                                <input type="date" id="date_to" class="form-control" style="background-color:#1e293b;color:#fff;border:1px solid #3e4651;">
                            </div>
                        </div>
                        <h4 class="example-title"
                            style="color:#fff;margin-top:20px"
                        >
                            Filter by IP Address
                        </h4>
                        <div class="form-group">
                            <input type="text" id="filter_ip" class="form-control" style="background-color:#1e293b;color:#fff;border:1px solid #3e4651;" placeholder="Enter IP Address">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Date Filter:</label>
                            <select class="form-control" id="date_filter">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="last_week">Last 7 Days</option>
                                <option value="last_month">Last 30 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>&nbsp;</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_no_transactions" value="true">
                                <label class="form-check-label" for="show_no_transactions">
                                    Show devices without transactions only
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-wrapper">
                    <div class="table-responsive">
                <div class="mb-3">
                    <button type="button" class="btn btn-danger" id="bulk-remove-btn" style="display: none;">
                        <i class="fa fa-trash"></i> Remove Selected Playlists
                    </button>
                    <span id="selection-info" class="ml-2 text-info" style="display: none;"></span>
                </div>
                <table class="table" id="item-list-table">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <input type="checkbox" id="select-all-checkbox"> Select All
                            </th>
                            <th>MAC Address</th>
                            <th>IP Address</th>
                            <th>App Type</th>
                            <th>Activation Source</th>
                            <th>Expire Date</th>
                            <th>Created Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Remove Playlists Confirmation Modal -->
<div class="modal fade" id="remove-playlists-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Confirm Playlist Removal</h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p>Are you sure you want to remove <span id="selected-count">0</span> selected playlist(s)?</p>
                <p><strong>This will permanently delete:</strong></p>
                <ul>
                    <li>All playlist URLs for selected devices</li>
                    <li>Device registration data</li>
                    <li>Associated transaction history</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRemovePlaylists()">
                    <i class="fa fa-trash"></i> Remove Playlists
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="activate-confirm-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Confirm Activation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure to activate this playlist?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="confirmActivate()">Confirm</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deactivate-confirm-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Confirm DeActivation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure to deactivate this playlist?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="confirmActivate(false)">Confirm</button>
            </div>
        </div>
    </div>
</div>
<script>
    var current_tr, current_playlist_id, dataTable, current_button;
    $(document).ready(function () {
        dataTable=$('#item-list-table').DataTable({
            autoFill: false
        });
    })

    var columns = [
        {
            data: null,
            sortable: false,
            render: function (data, type, row) {
                return '<input type="checkbox" class="playlist-checkbox" data-mac="' + row.mac_address + '">';
            }
        },
        {data: 'mac_address', sortable: false},
        {data: 'ip', sortable: true, render: function (data, type, row) {
            return '<a href="#" onclick="filterByIp(\'' + data + '\'); return false;">' + data + '</a>';
        }},
        {data: 'app_type', sortable: true},
        { data: "activation_source" },
        {data: 'expire_date', sortable: true},
        {data: 'created_time', sortable: true},
        {data: 'action', sortable: false}
    ];

    $(document).ready(function () {
        updateDataTable();
    })
    function updateDataTable(){
        dataTable.destroy();
        dataTable=$('#item-list-table').DataTable({
            'processing': true,
            'serverSide': true,
            'serverMethod': 'post',
            "order": [[ 5, "desc" ]],
            autoFill: false,
            pageLength: 50,
            'ajax':{
                url:site_url+"/admin/playlist/getPlaylists",
                data:function(data){
                    data.show_samsung = $('#show_samsung').prop('checked');
                    data.show_android = $('#show_android').prop('checked');
                    data.show_lg = $('#show_lg').prop('checked');
                    data.show_ios = $('#show_ios').prop('checked');
                    data.show_macos = $('#show_macOS').prop('checked');
                    data.show_tvos = $('#show_tvOS').prop('checked');
                    data.show_activated = $('#show_activated').prop('checked');
                    data.show_trial = $('#show_trial').prop('checked');
                    let date_filter = $('#date_filter').val();
                    let date_from = $('#date_from').val();
                    let date_to = $('#date_to').val();
                    let filter_ip = $('#filter_ip').val();
                    let show_no_transactions = $('#show_no_transactions').is(':checked') ? 'true' : 'false';
                    data.date_filter = date_filter;
                    data.date_from = date_from;
                    data.date_to = date_to;
                    data.filter_ip = filter_ip;
                    data.show_no_transactions = show_no_transactions;
                },
                "dataSrc": function ( json ) {
                    return json.data;
                }
            },
            'columns': columns
        });
    }
    $(document).on('click','.btn-activate', function () {
        current_tr=$(this).closest('tr');
        current_playlist_id=$(this).data('playlist_id');
        current_button=$(this);
        $('#inputRadiosUnchecked').prop('checked',true);
        $('#activate-confirm-modal').modal('show');
    })

    $(document).on('click','.btn-deactivate', function () {
        current_tr=$(this).closest('tr');
        current_playlist_id=$(this).data('playlist_id');
        current_button=$(this);
        $('#deactivate-confirm-modal').modal('show');
    })

    function confirmActivate(action=true) {
        $.ajax({
            method:'post',
            dataType:'json',
            url:site_url+"/admin/playlist/activate",
            data:{
                playlist_id:current_playlist_id,
                action:action ? 1 : 0,
            },
            success:data=>{
                if(data.status==='success'){
                    $('#activate-confirm-modal').modal('hide');
                    $('#deactivate-confirm-modal').modal('hide');

                    $(current_tr).find('td:eq(2)').text(data.expire_date);
                    if(action){
                        $(current_button).text('Deactivate').removeClass('btn-activate').addClass('btn-deactivate');
                        $(current_button).removeClass('btn-success').addClass('btn-danger');
                    }
                    else{
                        $(current_button).text('Activate').removeClass('btn-deactivate').addClass('btn-activate');
                        $(current_button).removeClass('btn-danger').addClass('btn-success');
                    }
                }else{
                    showErrorNotify(data.msg);
                }
            }
        })
    }

    $('#show_android').change(function () {
        updateDataTable();
    })
    $('#show_samsung').change(function () {
        updateDataTable();
    })
    $('#show_ios').change(function () {
        updateDataTable();
    })
    $('#show_lg').change(function () {
        updateDataTable();
    })

    $('#show_activated').change(function () {
        updateDataTable();
    })

    $('#show_trial').change(function () {
        updateDataTable();
    })

    $('#show_tvOS').change(function () {
        updateDataTable();
    })
    $('#show_macOS').change(function () {
        updateDataTable();
    })

    $('#date_filter').change(function () {
        if($(this).val() === 'custom') {
            $('#custom_date_range').show();
        } else {
            $('#custom_date_range').hide();
        }
        updateDataTable();
    })

    $('#date_from, #date_to').change(function () {
        if($('#date_filter').val() === 'custom') {
            updateDataTable();
        }
    })

    $('#filter_ip').on('keyup', function() {
        updateDataTable();
    });

    function filterByIp(ip_address) {
        $('#filter_ip').val(ip_address);
        updateDataTable();
    }

    $('#filter_ip').change(function(){
                    updateDataTable();
                });

                $('#show_no_transactions').change(function(){
                    updateDataTable();
                });

    // Checkbox selection functionality
    var selectedMACs = [];

    // Select all checkbox
    $(document).on('change', '#select-all-checkbox', function() {
        var isChecked = $(this).prop('checked');
        $('.playlist-checkbox').prop('checked', isChecked);
        updateSelectedMACs();
    });

    // Individual checkbox change
    $(document).on('change', '.playlist-checkbox', function() {
        updateSelectedMACs();
        
        // Update select-all checkbox state
        var totalCheckboxes = $('.playlist-checkbox').length;
        var checkedCheckboxes = $('.playlist-checkbox:checked').length;
        
        $('#select-all-checkbox').prop('checked', totalCheckboxes === checkedCheckboxes);
    });

    // Update selected MAC addresses and UI
    function updateSelectedMACs() {
        selectedMACs = [];
        $('.playlist-checkbox:checked').each(function() {
            selectedMACs.push($(this).data('mac'));
        });
        
        if (selectedMACs.length > 0) {
            $('#bulk-remove-btn').show();
            $('#selection-info').text(selectedMACs.length + ' playlist(s) selected').show();
        } else {
            $('#bulk-remove-btn').hide();
            $('#selection-info').hide();
        }
    }

    // Bulk remove button click
    $(document).on('click', '#bulk-remove-btn', function() {
        if (selectedMACs.length > 0) {
            $('#selected-count').text(selectedMACs.length);
            $('#remove-playlists-modal').modal('show');
        }
    });

    // Confirm playlist removal
    function confirmRemovePlaylists() {
        if (selectedMACs.length === 0) {
            return;
        }
        
        $.ajax({
            method: 'post',
            dataType: 'json',
            url: site_url + "/admin/playlist/remove-playlists",
            data: {
                mac_addresses: selectedMACs
            },
            success: function(data) {
                $('#remove-playlists-modal').modal('hide');
                if (data.success) {
                    Toastify({
                        text: data.message || "Playlists removed successfully!",
                        backgroundColor: "green"
                    }).showToast();
                    
                    // Clear selections and refresh table
                    selectedMACs = [];
                    $('#select-all-checkbox').prop('checked', false);
                    updateSelectedMACs();
                    updateDataTable();
                } else {
                    Toastify({
                        text: data.message || "Failed to remove playlists.",
                        backgroundColor: "red"
                    }).showToast();
                }
            },
            error: function() {
                $('#remove-playlists-modal').modal('hide');
                Toastify({
                    text: "Error occurred while removing playlists.",
                    backgroundColor: "red"
                }).showToast();
            }
        });
    }
</script>