<style>
    .detail-item{
        display: grid;
        grid-template-columns: 100px auto;
    }
    .playlist-item-label{
        width:70px;
        font-weight: bold;
    }
    .playlist-item-wrapper {
        margin: 10px 0;
    }
    .playlist-item-detail-wrapper {
        display: grid;
        grid-template-columns: 70px 1fr;
    }
    .reseller-activity-label {
        margin-top: 20px;
        color: #111;
        font-size: 18px;
        font-weight: 500;
    }
    .reseller-activity-info-item span {
        display: inline-block;
        vertical-align: middle;
    }
    .reseller-activity-info-item-label {
        width: 120px;
        padding-right: 10px;
    }
    .reseller-activity-item-container {
        margin-bottom: 10px;
    }
</style>
<div class="page-content">
    <div class="panel panel-boxed">
        <div class="panel-heading">
            <h3 class="panel-title">Play List Detail</h3>
        </div>
        <div class="panel-body">
            <div class="detail-item">
                <span class="detail-item-label">Mac Address: </span>
                <span class="detail-item-content"><%=device.mac_address%></span>
            </div>
            <div class="detail-item">
                <span class="detail-item-label">Expire Date: </span>
                <span class="detail-item-content" id="expire_date"><%=device.expire_date%></span>
            </div>
            <div class="detail-item">
                <span class="detail-item-label">Urls: </span>
                <span class="detail-item-content">
                    <%playlists.map(url=>{%>
                        <div class="playlist-item-wrapper">
                            <div class="playlist-item-detail-wrapper">
                                <div class="playlist-item-label">Url: </div>
                                <div class="playlist-item-value"><%=url.url%></div>
                            </div>
                        </div>
                    <%})%>
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-item-label">Transactions: </span>
                <span class="detail-item-content">
                    <%transactions.map(transaction=>{%>
                        $<%=transaction.amount%> <%=transaction.status%><br>
                        Payment ID: <%=transaction.payment_id%><br>
                        IP: <%=transaction.ip%><br>
                        User Agent: <%=transaction.user_agent%><br>
                        Admin IP: <%=transaction.admin_activation_ip || 'N/A'%> <br>
                        Admin Domain: <%=transaction.admin_activation_domain || 'N/A'%> <br>
                        Admin Source: <%=transaction.admin_activation_source || 'N/A'%> <br>
                    <%})%>
                </span>
            </div>
            <%if(reseller_activities.length>0){%>
            <div class="reseller-activity-items-container">
                <div class="reseller-activity-label">Reseller Activations For This Device: </div>
                <%reseller_activities.map(item=>{%>
                    <div class="reseller-activity-item-container">
                        <div class="reseller-activity-info-item">
                            <span class="reseller-activity-info-item-label">Reseller Email:</span>
                            <span class="reseller-activity-info-item-value"><%=item.reseller_email%></span>
                        </div>
                        <div class="reseller-activity-info-item">
                            <span class="reseller-activity-info-item-label">From:</span>
                            <span class="reseller-activity-info-item-value"><%=item.from_date%></span>
                        </div>
                        <div class="reseller-activity-info-item">
                            <span class="reseller-activity-info-item-label">To:</span>
                            <span class="reseller-activity-info-item-value"><%=item.to_date%></span>
                        </div>
                        <div class="reseller-activity-info-item">
                            <span class="reseller-activity-info-item-label">Activity Time: </span>
                            <span class="reseller-activity-info-item-value"><%=item.activity_time%></span>
                        </div>
                    </div>
                <%})%>
            </div>
            <%}%>

            <div class="detail-item">
                <%if(device.is_trial!=2){%>
                    <button class="btn btn-success btn-activate">Activate</button>
                <%}else{%>
                    <button class="btn btn-danger btn-deactivate">Deactivate</button>
                <%}%>
            </div>

            <div class="detail-item" style="margin-top: 15px;">
                <span class="detail-item-label">Admin Tools: </span>
                <span class="detail-item-content">
                    <button class="btn btn-warning btn-unlock-playlist" style="margin-right: 10px;">
                        <i class="fa fa-unlock"></i> Unlock Blocked Playlist
                    </button>
                    <button class="btn btn-info btn-change-parental-pin">
                        <i class="fa fa-key"></i> Change Parental PIN
                    </button>
                </span>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="activate-confirm-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Confirm Activation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure to activate this playlist?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="confirmActivate(true)">Confirm</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deactivate-confirm-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Confirm DeActivation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure to deactivate this playlist?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="confirmActivate(false)">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Unlock Blocked Playlist Modal -->
<div class="modal fade" id="unlock-playlist-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Unlock Blocked Playlist</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to unlock all blocked channels/content for this playlist?</p>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This will remove all parental controls and content restrictions.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmUnlockPlaylist()">
                    <i class="fa fa-unlock"></i> Unlock Playlist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Parental PIN Modal -->
<div class="modal fade" id="change-pin-modal">
    <div class="modal-dialog modal-simple modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Change Parental PIN</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-pin">New PIN (4 digits):</label>
                    <input type="number" class="form-control" id="new-pin" placeholder="Enter 4-digit PIN" min="1000" max="9999">
                    <small class="text-muted">PIN must be exactly 4 digits (1000-9999)</small>
                </div>
                <div class="form-group">
                    <label for="confirm-pin">Confirm PIN:</label>
                    <input type="number" class="form-control" id="confirm-pin" placeholder="Confirm PIN" min="1000" max="9999">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="confirmChangePin()">
                    <i class="fa fa-key"></i> Change PIN
                </button>
            </div>
        </div>
    </div>
</div>

<div>
    <script>
        var current_button;
        var current_playlist_id="<%=device._id%>";
        $(document).on('click','.btn-activate', function () {
            current_button=$(this);
            $('#activate-confirm-modal').modal('show');
        })
        $(document).on('click','.btn-deactivate', function () {
            current_button=$(this);
            $('#deactivate-confirm-modal').modal('show');
        })

        $(document).on('click','.btn-unlock-playlist', function () {
            $('#unlock-playlist-modal').modal('show');
        })

        $(document).on('click','.btn-change-parental-pin', function () {
            $('#new-pin').val('');
            $('#confirm-pin').val('');
            $('#change-pin-modal').modal('show');
        })

        function confirmActivate(action=true) {
            $.ajax({
                method:'post',
                dataType:'json',
                url:site_url+"/admin/playlist/activate",
                data:{
                    playlist_id:current_playlist_id,
                    action:action ? 1 : 0
                },
                success:data=>{
                    $('#activate-confirm-modal').modal('hide');
                    $('#deactivate-confirm-modal').modal('hide');
                    $('#expire_date').text(data.expire_date);
                    if(action){
                        $(current_button).text('Deactivate').removeClass('btn-activate').addClass('btn-deactivate');
                        $(current_button).removeClass('btn-success').addClass('btn-danger');
                    }
                    else{
                        $(current_button).text('Activate').removeClass('btn-deactivate').addClass('btn-activate');
                        $(current_button).removeClass('btn-danger').addClass('btn-success');
                    }
                }
            })
        }

        function confirmUnlockPlaylist() {
            $.ajax({
                method: 'post',
                dataType: 'json',
                url: site_url + "/admin/playlist/unlock-blocked",
                data: {
                    playlist_id: current_playlist_id
                },
                success: function(data) {
                    $('#unlock-playlist-modal').modal('hide');
                    if(data.success) {
                        Toastify({
                            text: data.message || "Playlist unlocked successfully!",
                            backgroundColor: "green"
                        }).showToast();
                    } else {
                        Toastify({
                            text: data.message || "Failed to unlock playlist.",
                            backgroundColor: "red"
                        }).showToast();
                    }
                },
                error: function() {
                    $('#unlock-playlist-modal').modal('hide');
                    Toastify({
                        text: "Error occurred while unlocking playlist.",
                        backgroundColor: "red"
                    }).showToast();
                }
            });
        }

        function confirmChangePin() {
            var newPin = $('#new-pin').val();
            var confirmPin = $('#confirm-pin').val();
            
            if(!newPin || !confirmPin) {
                Toastify({
                    text: "Please enter both PIN fields.",
                    backgroundColor: "red"
                }).showToast();
                return;
            }
            
            if(newPin.length !== 4 || confirmPin.length !== 4) {
                Toastify({
                    text: "PIN must be exactly 4 digits.",
                    backgroundColor: "red"
                }).showToast();
                return;
            }
            
            if(newPin !== confirmPin) {
                Toastify({
                    text: "PINs do not match. Please try again.",
                    backgroundColor: "red"
                }).showToast();
                return;
            }
            
            $.ajax({
                method: 'post',
                dataType: 'json',
                url: site_url + "/admin/playlist/change-parental-pin",
                data: {
                    playlist_id: current_playlist_id,
                    new_pin: newPin
                },
                success: function(data) {
                    $('#change-pin-modal').modal('hide');
                    if(data.success) {
                        Toastify({
                            text: data.message || "Parental PIN changed successfully!",
                            backgroundColor: "green"
                        }).showToast();
                    } else {
                        Toastify({
                            text: data.message || "Failed to change PIN.",
                            backgroundColor: "red"
                        }).showToast();
                    }
                },
                error: function() {
                    $('#change-pin-modal').modal('hide');
                    Toastify({
                        text: "Error occurred while changing PIN.",
                        backgroundColor: "red"
                    }).showToast();
                }
            });
        }
    </script>
</div>