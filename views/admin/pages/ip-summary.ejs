<style>
    .filter-wrapper label{
        color:#fff !important;
    }

    /* DataTables Select Styles */
    table.dataTable tbody tr.selected {
        background-color: #b0bed9 !important;
    }
    .dt-buttons {
        margin-bottom: 15px;
    }
    .dt-buttons .dt-button {
        margin-right: 5px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .dt-buttons .dt-button:hover {
        background: #e9ecef;
    }
    .dt-buttons .dt-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
<div class="page-content">
    <div class="panel panel-boxed">
        <div class="panel-heading">
            <h3 class="panel-title">IP Summary</h3>
        </div>
        <div class="panel-body">
            <div class="list-container">
                <div class="filter-wrapper">
                    <div class="select-country-wrapper">
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_android" checked>
                            <label for="show_android">Show Android</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_samsung" checked>
                            <label for="show_samsung">Show Samsung</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_lg" checked>
                            <label for="show_lg">Show Lg</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_ios" checked>
                            <label for="show_ios">Show iOS</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_tvOS" checked>
                            <label for="show_tvOS">Show tvOS</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_macOS" checked>
                            <label for="show_macOS">Show macOS</label>
                        </div>
                        <h4 class="example-title"
                            style="color:#fff;margin-top:20px"
                        >
                            Filter by activated status
                        </h4>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_activated" checked>
                            <label for="show_activated">Show Activate</label>
                        </div>
                        <div class="checkbox-custom checkbox-primary">
                            <input type="checkbox" id="show_trial" checked>
                            <label for="show_trial">Show Trial</label>
                        </div>
                    </div>
                </div>
                <div class="list-wrapper">
                    <div class="table-responsive">
                <table class="table" id="item-list-table">
                    <thead class="table-dark">
                        <tr>
                            <th>IP Address</th>
                            <th>Total Registered Devices</th>
                            <th>Activated Devices</th>
                            <th>Is Blocked</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
</div>
</div>

<script>
    var current_tr, current_playlist_id, dataTable, current_button;
    $(document).ready(function () {
        dataTable=$('#item-list-table').DataTable({
            autoFill: false
        });
    })

    var columns = [
        {data: 'ip', sortable: true},
        {data: 'total_registered_devices'},
        {data: 'activated_devices'},
        {data: 'is_blocked'},
    ];

    $(document).ready(function () {
        updateDataTable();
    })
    function updateDataTable(){
        dataTable.destroy();
        dataTable=$('#item-list-table').DataTable({
            'processing': true,
            'serverSide': true,
            'serverMethod': 'post',
            "order": [[ 1, "desc" ]],
            autoFill: false,
            pageLength: 50,
            select: {
                style: 'multi',  // Allows multiple row selection
                selector: 'td',  // Allows clicking anywhere on the row to select
                info: true      // Shows selected row count in the table info
            },
            dom: 'Bfrtip',      // Adds buttons to the table
            buttons: [
                'selectAll',    // Button to select all rows
                'selectNone',   // Button to deselect all rows
                {
                    text: 'Block Selected IPs',
                    className: 'btn-danger',
                    action: function () {
                        var selectedData = dataTable.rows({ selected: true }).data();
                        var selectedIPs = [];
                        selectedData.each(function(data) {
                            selectedIPs.push(data.ip);
                        });
                        console.log('Selected IPs:', selectedIPs);
                        if (selectedIPs.length > 0) {
                            $.ajax({
                                url: site_url + '/admin/block-ips',
                                type: 'POST',
                                data: { ips: selectedIPs },
                                success: function(response) {
                                    Toastify({
                                        text: "IPs blocked",
                                    }).showToast();
                                    console.log('IPs blocked:', response);
                                }
                            });
                        }
                    }
                },
                {
                    text: 'Unblock Selected IPs',
                    className: 'btn-success',
                    action: function () {
                        var selectedData = dataTable.rows({ selected: true }).data();
                        var selectedIPs = [];
                        selectedData.each(function(data) {
                            selectedIPs.push(data.ip);
                        });
                        console.log('Selected IPs:', selectedIPs);
                        if (selectedIPs.length > 0) {
                            $.ajax({
                                url: site_url + '/admin/unblock-ips',
                                type: 'POST',
                                data: { ips: selectedIPs },
                                success: function(response) {
                                    Toastify({
                                        text: "IPs unblocked",
                                    }).showToast();
                                    console.log('IPs unblocked:', response);
                                }
                            });
                        }
                    }
                },
                {
                    text: 'Remove Devices of Selected IPs',
                    className: 'btn-danger',
                    action: function () {
                        var selectedData = dataTable.rows({ selected: true }).data();
                        var selectedIPs = [];
                        selectedData.each(function(data) {
                            selectedIPs.push(data.ip);
                        });
                        console.log('Selected IPs:', selectedIPs);
                        if (selectedIPs.length > 0) {
                            $.ajax({
                                url: site_url + '/admin/remove-devices-of-ips',
                                type: 'POST',
                                data: { ips: selectedIPs },
                                success: function(response) {
                                    console.log('Devices removed:', response);

                                    Toastify({
                                        text: "Devices removed",
                                    }).showToast();

                                    dataTable.rows({ selected: true }).remove().draw();
                                }
                            });
                        }
                    }
                }
            ],
            'ajax':{
                url:site_url+"/admin/get-ip-summary",
                data:{
                    show_samsung:$('#show_samsung').prop('checked'),
                    show_android:$('#show_android').prop('checked'),
                    show_lg:$('#show_lg').prop('checked'),
                    show_ios:$('#show_ios').prop('checked'),
                    show_macos:$('#show_macOS').prop('checked'),
                    show_tvos:$('#show_tvOS').prop('checked'),
                    show_activated:$('#show_activated').prop('checked'),
                    show_trial:$('#show_trial').prop('checked')
                },
                "dataSrc": function ( json ) {
                    return json.data;
                }
            },
            'columns': columns,
            'columnDefs': [
                {
                    'targets': 0, // IP Address column
                    'render': function(data, type, row) {
                        return '<a href="/admin/playlist?filter_ip=' + data + '" target="_blank" style="color: #007bff; text-decoration: underline;">' + data + '</a>';
                    }
                },
                {
                    'targets': 2, // Activated Devices column
                    'render': function(data, type, row) {
                        return '<a href="/admin/playlist?filter_ip=' + row.ip + '&show_activated=true&show_trial=false" target="_blank" style="color: #28a745; text-decoration: underline;">' + data + '</a>';
                    }
                }
            ]
        });

        // Add selection change event listener
        dataTable.on('select deselect', function () {
            var selectedRows = dataTable.rows({ selected: true }).count();
            if (selectedRows > 0) {
                $('.dt-buttons .buttons-selected').prop('disabled', false);
            } else {
                $('.dt-buttons .buttons-selected').prop('disabled', true);
            }
        });
    }

    $(document).on('click','.btn-activate', function () {
        current_tr=$(this).closest('tr');
        current_playlist_id=$(this).data('playlist_id');
        current_button=$(this);
        $('#inputRadiosUnchecked').prop('checked',true);
        $('#activate-confirm-modal').modal('show');
    })

    $(document).on('click','.btn-deactivate', function () {
        current_tr=$(this).closest('tr');
        current_playlist_id=$(this).data('playlist_id');
        current_button=$(this);
        $('#deactivate-confirm-modal').modal('show');
    })

    $('#show_android').change(function () {
        updateDataTable();
    })
    $('#show_samsung').change(function () {
        updateDataTable();
    })
    $('#show_ios').change(function () {
        updateDataTable();
    })
    $('#show_lg').change(function () {
        updateDataTable();
    })

    $('#show_activated').change(function () {
        updateDataTable();
    })

    $('#show_trial').change(function () {
        updateDataTable();
    })

    $('#show_tvOS').change(function () {
        updateDataTable();
    })
    $('#show_macOS').change(function () {
        updateDataTable();
    })
</script>
