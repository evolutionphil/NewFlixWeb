<link rel="stylesheet" href="frontend/activation.css">

<!-- Page Header - Always at Top for Both Desktop and Mobile -->
<section style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 2rem 0; margin-bottom: 2rem; text-align: center;">
    <div class="container">
        <h1 class="text-white font-weight-bold mb-2" style="font-size: 2rem;">Platform Activation</h1>
        <p class="text-muted mb-0" style="font-size: 1.1rem;">Set up your streaming platform subscription</p>
    </div>
</section>

<!-- Professional Hero Section -->
<section class="hero-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 3rem 0; border-radius: 20px; margin-bottom: 2rem;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem; text-align: center;">
        <h1 style="color: #ffffff; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
            Professional Streaming Platform Activation
        </h1>
        <p style="color: #b8c5d6; font-size: 1.2rem; max-width: 800px; margin: 0 auto; line-height: 1.6;">
            Activate your streaming platform subscription with secure payment processing and instant device activation across all supported platforms.
        </p>
    </div>
</section>

<!-- Professional Features Section -->
<section class="features-section" style="background: rgba(255, 255, 255, 0.02); padding: 2rem; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 2rem;">
    <div class="row">
        <div class="col-md-4 mb-3">
            <div style="text-align: center;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fa fa-key" style="color: white; font-size: 24px;"></i>
                </div>
                <h3 style="color: #ffffff; font-size: 1.2rem; margin-bottom: 0.5rem;">Instant Activation</h3>
                <p style="color: #b8c5d6; font-size: 0.9rem; margin: 0;">Immediate platform activation after successful payment</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div style="text-align: center;">
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fa fa-credit-card" style="color: white; font-size: 24px;"></i>
                </div>
                <h3 style="color: #ffffff; font-size: 1.2rem; margin-bottom: 0.5rem;">Secure Payment</h3>
                <p style="color: #b8c5d6; font-size: 0.9rem; margin: 0;">Multiple payment options with enterprise-grade security</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div style="text-align: center;">
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fa fa-devices" style="color: white; font-size: 24px;"></i>
                </div>
                <h3 style="color: #ffffff; font-size: 1.2rem; margin-bottom: 0.5rem;">Multi-Device Support</h3>
                <p style="color: #b8c5d6; font-size: 0.9rem; margin: 0;">Compatible with all major streaming devices and platforms</p>
            </div>
        </div>
    </div>
</section>

<!-- Hidden SEO Content - Comprehensive Streaming App Activation Keywords -->
<div style="display: none; position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
    <h1>Streaming Platform Activation Service and Device Registration</h1>
    <h2>Professional Streaming Technology Activation and Payment Processing</h2>
    <p>Complete streaming platform activation service for all major streaming applications, device registration, subscription management, payment processing, and instant activation across multiple streaming technologies and digital entertainment platforms.</p>
    
    <!-- Hidden Keywords for SEO - All Popular Streaming Apps and Activation Terms -->
    <div style="visibility: hidden; display: none;">
        IPTV activation, streaming activation, M3U IPTV activation, IPTV player activation, Smart IPTV activation, GSE IPTV activation, Net IPTV activation, Set IPTV activation, Get IPTV activation, Upload IPTV activation, Home IPTV activation, IBO Player activation, IBO Player Pro activation, IBO Player IPTV activation, IBO IPTV activation, IPTV Smarters activation, IPTV Smarters Pro activation, Perfect Player activation, Perfect Player IPTV activation, VLC IPTV activation, VLC Media Player activation, MX Player IPTV activation, MX Player Pro activation, TiviMate IPTV activation, TiviMate Premium activation, IPTV Extreme activation, IPTV Extreme Pro activation, Duplex IPTV activation, OTT Player activation, OTTPlayer activation, Lazy IPTV activation, IPTV Pro activation, SS IPTV activation, Smart IPTV Samsung activation, Smart IPTV LG activation, MyIPTV Player activation, MyIPTV Player Pro activation, Live NetTV activation, Live NetTV Pro activation, Purple IPTV activation, Purple Smart TV activation, STB Emulator activation, STB EMU activation, MAG Player activation, MAG Box activation, Stalker Portal activation, Stalker Middleware activation, Ministra Player activation, Infomir MAG activation, GSE Smart IPTV activation, IPTV Ultimate activation, XCIPTV activation, ImPlayer activation, Televizo activation, Free IPTV activation, IPTV Channels activation, IPTV Playlist activation, M3U8 Streaming activation, TV Streaming activation, Online TV activation, Internet TV activation, Cord Cutting activation, Streaming Apps activation, FireStick IPTV activation, Android TV IPTV activation, Roku IPTV activation, Smart TV Streaming activation, IPTV Server activation, IPTV Provider activation, IPTV Subscription activation, IPTV Box activation, Kodi IPTV activation, Kodi Addons activation, Plex IPTV activation, Emby IPTV activation, Jellyfin IPTV activation, ibo iptv activation, smart iptv activation, gse iptv activation, net iptv activation, set iptv activation, perfect player activation, vlc iptv activation, mx player activation, tivimate activation, iptv extreme activation, duplex iptv activation, ottplayer activation, lazy iptv activation, iptv pro activation, ss iptv activation, iptv smarters activation, myiptv player activation, live nettv activation, purple iptv activation, stb emulator activation, mag player activation, stalker portal activation, ministra player activation, infomir mag activation, gse smart iptv activation, iptv ultimate activation, xciptv activation, implayer activation, televizo activation, kodi iptv activation, plex iptv activation, emby iptv activation, jellyfin iptv activation, activate iptv, activate smart iptv, activate gse iptv, activate net iptv, activate set iptv, activate ibo player, activate perfect player, activate vlc iptv, activate mx player, activate tivimate, activate iptv extreme, activate duplex iptv, activate ottplayer, activate lazy iptv, activate iptv pro, activate ss iptv, activate iptv smarters, activation iptv, activation smart iptv, activation gse iptv, activation net iptv, activation set iptv, activation ibo player, activation perfect player, activation vlc iptv, activation mx player, activation tivimate, activation iptv extreme, activation duplex iptv, activation ottplayer, activation lazy iptv, activation iptv pro, activation ss iptv, activation iptv smarters, iptv activation service, smart iptv activation service, gse iptv activation service, net iptv activation service, set iptv activation service, ibo player activation service, perfect player activation service, vlc iptv activation service, mx player activation service, tivimate activation service, iptv extreme activation service, duplex iptv activation service, ottplayer activation service, lazy iptv activation service, iptv pro activation service, ss iptv activation service, iptv smarters activation service, how to activate iptv, how to activate smart iptv, how to activate gse iptv, how to activate net iptv, how to activate set iptv, how to activate ibo player, how to activate perfect player, how to activate vlc iptv, how to activate mx player, how to activate tivimate, how to activate iptv extreme, how to activate duplex iptv, how to activate ottplayer, how to activate lazy iptv, how to activate iptv pro, how to activate ss iptv, how to activate iptv smarters, iptv activation code, smart iptv activation code, gse iptv activation code, net iptv activation code, set iptv activation code, ibo player activation code, perfect player activation code, vlc iptv activation code, mx player activation code, tivimate activation code, iptv extreme activation code, duplex iptv activation code, ottplayer activation code, lazy iptv activation code, iptv pro activation code, ss iptv activation code, iptv smarters activation code, iptv activation key, smart iptv activation key, gse iptv activation key, net iptv activation key, set iptv activation key, ibo player activation key, perfect player activation key, vlc iptv activation key, mx player activation key, tivimate activation key, iptv extreme activation key, duplex iptv activation key, ottplayer activation key, lazy iptv activation key, iptv pro activation key, ss iptv activation key, iptv smarters activation key, iptv activation process, smart iptv activation process, gse iptv activation process, net iptv activation process, set iptv activation process, ibo player activation process, perfect player activation process, vlc iptv activation process, mx player activation process, tivimate activation process, iptv extreme activation process, duplex iptv activation process, ottplayer activation process, lazy iptv activation process, iptv pro activation process, ss iptv activation process, iptv smarters activation process, iptv subscription activation, smart iptv subscription activation, gse iptv subscription activation, net iptv subscription activation, set iptv subscription activation, ibo player subscription activation, perfect player subscription activation, vlc iptv subscription activation, mx player subscription activation, tivimate subscription activation, iptv extreme subscription activation, duplex iptv subscription activation, ottplayer subscription activation, lazy iptv subscription activation, iptv pro subscription activation, ss iptv subscription activation, iptv smarters subscription activation, iptv device activation, smart iptv device activation, gse iptv device activation, net iptv device activation, set iptv device activation, ibo player device activation, perfect player device activation, vlc iptv device activation, mx player device activation, tivimate device activation, iptv extreme device activation, duplex iptv device activation, ottplayer device activation, lazy iptv device activation, iptv pro device activation, ss iptv device activation, iptv smarters device activation, iptv license activation, smart iptv license activation, gse iptv license activation, net iptv license activation, set iptv license activation, ibo player license activation, perfect player license activation, vlc iptv license activation, mx player license activation, tivimate license activation, iptv extreme license activation, duplex iptv license activation, ottplayer license activation, lazy iptv license activation, iptv pro license activation, ss iptv license activation, iptv smarters license activation, iptv account activation, smart iptv account activation, gse iptv account activation, net iptv account activation, set iptv account activation, ibo player account activation, perfect player account activation, vlc iptv account activation, mx player account activation, tivimate account activation, iptv extreme account activation, duplex iptv account activation, ottplayer account activation, lazy iptv account activation, iptv pro account activation, ss iptv account activation, iptv smarters account activation, iptv app activation, smart iptv app activation, gse iptv app activation, net iptv app activation, set iptv app activation, ibo player app activation, perfect player app activation, vlc iptv app activation, mx player app activation, tivimate app activation, iptv extreme app activation, duplex iptv app activation, ottplayer app activation, lazy iptv app activation, iptv pro app activation, ss iptv app activation, iptv smarters app activation, streaming platform activation, streaming service activation, streaming technology activation, digital entertainment activation, streaming industry activation, streaming application activation, streaming device activation, streaming software activation, streaming player activation, streaming solution activation, streaming system activation, streaming network activation, streaming platform registration, streaming service registration, streaming technology registration, digital entertainment registration, streaming industry registration, streaming application registration, streaming device registration, streaming software registration, streaming player registration, streaming solution registration, streaming system registration, streaming network registration, streaming platform subscription, streaming service subscription, streaming technology subscription, digital entertainment subscription, streaming industry subscription, streaming application subscription, streaming device subscription, streaming software subscription, streaming player subscription, streaming solution subscription, streaming system subscription, streaming network subscription, streaming platform payment, streaming service payment, streaming technology payment, digital entertainment payment, streaming industry payment, streaming application payment, streaming device payment, streaming software payment, streaming player payment, streaming solution payment, streaming system payment, streaming network payment, streaming platform purchase, streaming service purchase, streaming technology purchase, digital entertainment purchase, streaming industry purchase, streaming application purchase, streaming device purchase, streaming software purchase, streaming player purchase, streaming solution purchase, streaming system purchase, streaming network purchase, streaming platform billing, streaming service billing, streaming technology billing, digital entertainment billing, streaming industry billing, streaming application billing, streaming device billing, streaming software billing, streaming player billing, streaming solution billing, streaming system billing, streaming network billing, streaming platform checkout, streaming service checkout, streaming technology checkout, digital entertainment checkout, streaming industry checkout, streaming application checkout, streaming device checkout, streaming software checkout, streaming player checkout, streaming solution checkout, streaming system checkout, streaming network checkout, streaming platform order, streaming service order, streaming technology order, digital entertainment order, streaming industry order, streaming application order, streaming device order, streaming software order, streaming player order, streaming solution order, streaming system order, streaming network order, streaming platform invoice, streaming service invoice, streaming technology invoice, digital entertainment invoice, streaming industry invoice, streaming application invoice, streaming device invoice, streaming software invoice, streaming player invoice, streaming solution invoice, streaming system invoice, streaming network invoice, streaming platform receipt, streaming service receipt, streaming technology receipt, digital entertainment receipt, streaming industry receipt, streaming application receipt, streaming device receipt, streaming software receipt, streaming player receipt, streaming solution receipt, streaming system receipt, streaming network receipt, streaming platform transaction, streaming service transaction, streaming technology transaction, digital entertainment transaction, streaming industry transaction, streaming application transaction, streaming device transaction, streaming software transaction, streaming player transaction, streaming solution transaction, streaming system transaction, streaming network transaction
    </div>
    
    <p style="color: transparent; font-size: 1px; line-height: 1px;">Professional streaming platform activation service, secure payment processing, instant device activation, subscription management, streaming application registration, multi-device support, digital entertainment platform activation, streaming technology subscription, payment gateway integration, device registration service, streaming platform licensing, activation code generation, subscription billing system.</p>
</div>

<section style="--background-color: #06080C; --border-color: #473590; --angle: 112deg" class="news-container fancy-card mobile-content-wrapper">
    <div class="pb-4 news-section-header mobile-header-order">
        <h1 class="text-white news-section-title">Platform Activation</h1>
        <p class="news-section-subtitle">Set up your streaming platform subscription</p>
    </div>

    <div class="row">
    <!-- Payment Form - Mobile First -->
    <form class="col-md-6 order-md-2 order-1 mobile-payment-priority" method="post" action="/saveActivation" id="form">
        <div class="payment-card">
                <div class="payment-card-header">
                    <h4 class="text-white">Payment</h4>
                </div>

                <div class="mt-4">
                    <div class="form-group">
                        <label>Mac Address:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1"><i class="fas fa-map-marker"></i></span>
                            </div>
                            <input name="mac_address" id="mac-address" type="text" class="form-control mac-address" placeholder="00:aa:bb:cc:dd:11" maxlength="17" required>
                            <div class="input-group-append">
                                <button type="button" onclick="checkValidMac();" class="btn btn-sm btn-outline-secondary waves-effect">
                                    <i class="fas fa-check"></i> Check
                                </button>
                            </div>
                        </div>
                        <div id="mac-invalid-info-container">

                        </div>
                    </div>

                    <div id="mac-valid-info-container">
                        <div id="expire-date-container">
                            <span id="expire-date-label" class="text-white">
                                Expire Date after activate:
                            </span>
                            <span id="expire-date-value" class="text-white">
                                Life time.
                            </span>
                        </div>
                        <p id="price-text" class="text-white"><span>Price:</span><span class="price-value"> &euro;<%=price%></span></p>
                    </div>
                </div>

                <div id="payment-methods-part">
                    <div id="billing-info-section">
                        <div class="payment-section-label">
                            Billing Info
                        </div>
                        <!--                    <div class="form-group">-->
                        <label>Email *</label>
                        <input type="email" class="form-control" name="email" required placeholder="Your Email" id="email">
                        <!--                    </div>-->
                        <div id="email-error-message">Sorry, Email is not correct</div>
                    </div>

                    <div class="payment-section-label">
                        Select Payment Way
                    </div>

                    <div class="position-relative" id="payment-items-container">
                        <!-- Apple Pay / Google Pay Button -->
                        <div id="payment-request-container" style="display: none; margin-bottom: 20px;">
                            <div style="background: #1a1f2e; border: 1px solid #353b4a; border-radius: 10px; padding: 20px; text-align: center;">
                                <h5 class="text-white mb-3">Express Checkout</h5>
                                <div id="payment-request-button" style="width: 100%; min-height: 50px;"></div>
                                <small class="text-muted mt-2 d-block">Pay securely with Apple Pay or Google Pay</small>
                            </div>
                        </div>
                        
                        <!-- Or separator for Apple Pay -->
                        <div id="apple-pay-or-container" style="display: none;" class="position-relative or-container">
                            <div class="or-border"></div>
                            <div class="or text-center">Or</div>
                        </div>
                        
                        <%if(show_paypal==1){%>
                        <div id="paypal-element"></div>
                        <%if(show_coin==1 || show_mollie==1 || show_stripe==1){%>
                            <div id="" class="position-relative or-container">
                                <div class="or-border"></div>
                                <div class="or text-center">Or</div>
                            </div>
                        <%}%>
                        <%}%>
                        <%if(show_stripe==1){%>
                        <div class="payment-item-container">
                            <div class="payment-method-item-container">
                                Pay with Stripe
                            </div>
                            <div class="text-center mt-10 mb-10">
                                <button class="btn btn-primary" id="submit-btn-stripe">Pay Now</button>
                            </div>
                        </div>
                        <%if(show_coin==1){%>
                            <div class="position-relative or-container">
                                <div class="or-border"></div>
                                <div class="or text-center">Or</div>
                            </div>
                        <%}%>
                        <%}%>
                        <%if(show_mollie==1){%>
                        <div class="payment-item-container">
                            <div class="payment-method-item-container">
                                Pay with Mollie
                            </div>
                            <div class="text-center mt-10 mb-10">
                                <button class="btn btn-warning" id="submit-btn-stripe">Pay Now</button>
                            </div>
                        </div>
                        <%if(show_coin==1){%>
                            <div class="position-relative or-container">
                                <div class="or-border"></div>
                                <div class="or text-center">Or</div>
                            </div>
                        <%}%>
                        <%}%>
                        <%if(show_coin==1){%>
                        <div class="payment-item-container">
                            <div class="payment-method-item-container">
                                Pay with Crypto Currency
                            </div>
                            <div id="coin-select">
                                <label>Select Crypto Type</label>
                                <select class="form-control" id="coin_type">
                                    <%coin_list.map(item=>{%>
                                    <option value="<%=item['code']%>"><%=item['name']%></option>
                                    <%})%>
                                </select>
                            </div>

                            <div class="text-center mt-4">
                                <button class="btn btn-primary" id="submit-btn">Pay Now</button>
                            </div>
                        </div>
                        <%}%>
                        <!--
                        <div id="or-container" class="position-relative">
                            <div id="or-border"></div>
                            <div id="or" class="text-center">Or</div>
                        </div>
                        <div class="payment-item-container">
                            <div class="payment-method-item-container">
                                Pay with Credit Card
                            </div>
                            <div class="accepted-cards-logo"></div>
                            <div id="coin-select">
                             <!--   <div class="form-group">
                                    <label>
                                        Phone Number
                                        <input type="text" class="form-control" placeholder="Insert phone number" name="phonenumber" required>
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label style="width: 97%;">
                                        <small style="font-weight:600">Card Number</small>

                                        <input type="text" class="form-control" placeholder="Insert card number" name="cardnumber" required>
                                    </label>
                                </div>
                                <div class="form-group">
                                   <label style="width: 97%;">
                                       <small style="font-weight:600">Card Holder Full Name</small>

                                        <input type="text" class="form-control" placeholder="Insert card holder full name" name="cardHolderFullName" required>
                                    </label>
                                </div>

                                <div class="row">
                                    <div class="col-sm-4">
                                         <label style="width: 100%;">
                                              <small style="font-weight:600">Expire Month</small>

                                            <input type="number" min="01" max="12" minlength="2" maxlength="2" class="form-control" name="expMonth" placeholder="MM" required>
                                        </label>
                                    </div>
                                    <div class="col-sm-4">
                                        <label style="width: 100%;">
                                             <small style="font-weight:600">Expire Year</small>

                                            <input type="number" min="2021" max="2500" class="form-control" name="expYear" placeholder="YYYY" required>
                                        </label>
                                    </div>
                                     <div class="col-sm-4">
                                        <label style="width: 90%;">
                                            <small style="font-weight:600;font-size:12px">CVC</small>
                                            <input type="password" class="form-control" name="cvcNumber" placeholder="***" required>
                                        </label>
                                    </div>
                                </div>



                                <div class="text-center mt-10">
                                    <button class="btn btn-primary" name="payment_type" value="">Pay Now</button>
                                </div>
                            </div>
                             -->
                    </div>

                </div>
        </div>
    </form>
    
    <!-- Content Section - Mobile Second -->
    <div class="col-md-6 text-white order-md-1 order-2 mobile-content-order">
        <%if(activation_content){%>
            <%- activation_content.contents %>
        <%}%>
    </div>
</div>
</section>


<script src="https://js.stripe.com/v3/"></script>
<script>
    let stripe;
    try{
        stripe=Stripe('<%= stripe_public_key%>', {
            apiVersion: '2020-08-27',
        })
    }catch (e){

    }
    var payment_type='crypto', mac_valid=false, mac_address, email_valid=false;
    $(document).ready(function () {
        let messages=JSON.parse(`<%- JSON.stringify(messages)%>`)
        if(typeof messages.success!="undefined"){
            showErrorMessage('success',messages.success[0]);
        }
        else if(typeof messages.error!='undefined'){
            showErrorMessage('error',messages.error[0])
        }
    })

    function checkMacEmailValid(key){
        let mac_address=$('#mac-address').val()
        let email=$('#email').val();
        if(key=='mac-address'){
            let mac_regex= /^([0-9a-zA-Z]{2}[:]){5}[0-9a-f]{2}$/gmi;
            mac_valid=mac_regex.test(mac_address);
            if(mac_valid)
                $('#mac-error-message').slideUp();
            else
                $('#mac-error-message').slideDown();
        }
        if(key=='email'){
            let email_regex=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            email_valid=email_regex.test(email)
            if(email_valid)
                $('#email-error-message').slideUp();
            else
                $('#email-error-message').slideDown();
        }
    }

    $('#mac-address').change(function () {
        checkMacEmailValid('mac-address');
    })
    $('#email').change(function () {
        checkMacEmailValid('email');
        // Check and initialize payment request after email validation
        setTimeout(() => {
            if (mac_valid && email_valid && stripe && !paymentRequestInitialized) {
                initializePaymentRequest();
            }
        }, 100);
    })
    $('#mac-address').keyup(function () {
        checkMacEmailValid('mac-address');
    })
    $('#email').keyup(function () {
        checkMacEmailValid('email');
        // Check and initialize payment request after email validation
        setTimeout(() => {
            if (mac_valid && email_valid && stripe && !paymentRequestInitialized) {
                initializePaymentRequest();
            }
        }, 100);
    })


    // paypal.Buttons({
    //     // onInit: function(data, actions) {
    //     //     actions.disable();
    //     //
    //     // },
    //     onClick: function(data,actions) {
    //         if(!(mac_valid)){
    //             // showErrorMessage('error','Sorry, Mac address or Email is not valid');
    //             checkMacEmailValid('mac-address');
    //             return actions.reject();
    //         }
    //         if(!email_valid){
    //             checkMacEmailValid('email');
    //             return actions.reject();
    //         }
    //         let mac_address=$('#mac-address').val();
    //         return fetch("/checkMacValid",{
    //             method:'post',
    //             headers: {
    //                 'Content-Type': 'application/json'
    //             },
    //             body:JSON.stringify({
    //                 mac_address:mac_address
    //             }),
    //         }).then(function (res) {
    //             return res.json();
    //         }).then(data=>{
    //             console.log(data);
    //             if (data.status=='success') {
    //                 return actions.resolve();
    //             } else {
    //                 showErrorMessage('error',data.msg);
    //                 return actions.reject();
    //             }
    //         })
    //     },
    //     createOrder: function(data, actions) {
    //         let mac_address=$('#mac-address').val();
    //         return fetch(`/paypal/order/create`, {
    //             method: 'post',
    //             dataType:'json',
    //             headers: {
    //                 'Content-Type': 'application/json'
    //             },
    //             body:JSON.stringify({
    //                 mac_address:mac_address
    //             })
    //         }).then(function(res) {
    //             if(res.ok){
    //                 return res.json();
    //             }else{
    //                 $('#error-message').text(res.msg).slideDown();
    //             }
    //         }).then(
    //             function(orderData) {
    //                 console.log(orderData);
    //                 return orderData.id;
    //             },
    //             function (error) {
    //                 console.log(error);
    //             }
    //         );
    //     },
    //     // Finalize the transaction
    //     onApprove: function(data, actions) {
    //         return fetch(`/paypal/order/capture/${data.orderID}`, {
    //             method: 'post',
    //             headers: {
    //                 'Accept': 'application/json',
    //                 'Content-Type': 'application/json',
    //             },
    //             body:JSON.stringify({
    //                 mac_address:$('#mac-address').val(),
    //                 email:$('#email').val()
    //             })
    //         }).then(function(res) {
    //             console.log(res);
    //             return res.json();
    //         }).then(function(orderData) {
    //             console.log(orderData);
    //             var errorDetail = Array.isArray(orderData.details) && orderData.details[0];
    //             if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
    //                 return actions.restart();
    //             }
    //             if (errorDetail) {
    //                 var msg = 'Sorry, your transaction could not be processed.';
    //                 if (errorDetail.description) msg += '\n\n' + errorDetail.description;
    //                 if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
    //                 showErrorMessage('error', msg);
    //                 return;
    //             }
    //             showErrorMessage('success','Thanks for your payment, your mac address activated now.')
    //             // alert('Transaction completed by ' + orderData.payer.name.given_name);
    //         });
    //     }
    // }).render('#paypal-element');
    $('#submit-btn').click(function (e) {
        console.log('i ve clicked');
        e.preventDefault();
        if(!email_valid){
            checkMacEmailValid('email');
            return;
        }
        payment_type='crypto'
        let post_data={
            mac_address: $('#mac-address').val()
        };
        $.ajax({
            method:'post',
            url:'/checkMacValid',
            dataType:'json',
            data:post_data,
            success:(data)=>{
                if(data.status=='success'){
                    checkOut();
                }else{
                    showErrorMessage('error',data.msg);
                }
            }
        })
    })
    $('#submit-btn-stripe').click(function (e) {
        console.log('i ve clicked');
        e.preventDefault();
        if(!email_valid){
            checkMacEmailValid('email');
            return;
        }
        payment_type='stripe'
        let post_data={
            mac_address: $('#mac-address').val()
        };
        $.ajax({
            method:'post',
            url:'/checkMacValid',
            dataType:'json',
            data:post_data,
            success:(data)=>{
                if(data.status=='success'){
                    checkOut();
                }else{
                    showErrorMessage('error',data.msg);
                }
            }
        })
    })
    function checkOut() {
        if(payment_type!='stripe'){
            $("<input />").attr("type", "hidden")
                .attr("name", "payment_type")
                .attr("value", payment_type)
                .appendTo("#form");
            $("<input />").attr("type", "hidden")
                .attr("name", "coin_type")
                .attr("value", $('#coin_type').val())
                .appendTo("#form");
            $("#form").submit();
        }else{
            $('#submit-btn-stripe').attr('disabled',true)
            $.ajax(
                {
                    method:'post',
                    url:'/saveActivation',
                    data:{
                        mac_address:$('#mac-address').val(),
                        email:$('#email').val(),
                        payment_type:'stripe'
                    },
                    dataType: 'json',
                    success:data=>{
                        if(data.status==='success'){
                            stripe
                                .redirectToCheckout({
                                    sessionId: data.session_id,
                                })
                                .then(result=>{
                                    if(result.error)
                                    {
                                        alert(result.error.message)
                                        $('#submit-btn-stripe').removeAttr('disabled')
                                    }
                                });
                        }
                        else {
                            showErrorMessage('error','Sorry, something is wrong, please try again later')
                            $('#submit-btn-stripe').removeAttr('disabled')
                        }
                    }
                }
            )
        }
    }
    function checkValidMac(){
        mac_address=$('#mac-address').val();
        if(mac_address.length==17){
            $.ajax({
                method:'post',
                url:"/checkMacValid",
                dataType:'json',
                data:{
                    mac_address:mac_address
                },
                success:res=>{
                    if(res.status==="success"){
                        $('#payment-methods-part').slideDown();
                        // $('#expire-date-value').text(res.msg);
                        $('#mac-invalid-info-container').hide();
                        $('#mac-valid-info-container').slideDown();
                        
                        // Check and initialize payment request after successful MAC validation
                        setTimeout(() => {
                            if (mac_valid && email_valid && stripe && !paymentRequestInitialized) {
                                initializePaymentRequest();
                            }
                        }, 500);
                    }else{
                        $('#mac-valid-info-container').hide();
                        $('#mac-invalid-info-container').text(res.msg).slideDown();
                        $('#payment-methods-part').slideUp();
                    }
                }
            })
        }
    }

    // Apple Pay / Google Pay Setup using Stripe Payment Request
    let paymentRequest = null;
    let prButton = null;
    let paymentRequestInitialized = false;

    if (stripe) {
        // Initialize payment request only when both validations pass
        function initializePaymentRequest() {
            // Prevent multiple initializations
            if (paymentRequestInitialized) {
                return;
            }
            
            if (!mac_valid || !email_valid) {
                return;
            }

            paymentRequestInitialized = true;

            paymentRequest = stripe.paymentRequest({
                country: 'DE', // Germany
                currency: 'eur',
                total: {
                    label: 'FLIX APP Activation',
                    amount: Math.round(parseFloat('<%=price%>') * 100), // Convert to cents, ensure integer
                },
                requestPayerName: true,
                requestPayerEmail: true,
                requestShipping: false, // We don't need shipping for digital goods
            });

            // Check if Apple Pay/Google Pay is available FIRST
            paymentRequest.canMakePayment().then(function(result) {
                if (result) {
                    // Only create and mount the button if payment methods are available
                    const elements = stripe.elements();
                    prButton = elements.create('paymentRequestButton', {
                        paymentRequest: paymentRequest,
                        style: {
                            paymentRequestButton: {
                                theme: 'dark',
                                height: '50px',
                                type: 'buy', // Shows "Buy with Apple Pay" instead of generic button
                            },
                        },
                    });

                    document.getElementById('payment-request-container').style.display = 'block';
                    document.getElementById('apple-pay-or-container').style.display = 'block';
                    prButton.mount('#payment-request-button');
                } else {
                    document.getElementById('payment-request-container').style.display = 'none';
                    document.getElementById('apple-pay-or-container').style.display = 'none';
                }
            }).catch(function(error) {
                document.getElementById('payment-request-container').style.display = 'none';
                document.getElementById('apple-pay-or-container').style.display = 'none';
            });

            // Handle payment
            paymentRequest.on('paymentmethod', async function(ev) {
                // Get current values
                let current_mac = $('#mac-address').val();
                let current_email = $('#email').val();
                
                // Create payment intent on your server
                try {
                    const response = await fetch('/saveActivation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mac_address: current_mac,
                            email: current_email,
                            payment_type: 'stripe',
                            payment_method_id: ev.paymentMethod.id
                        }),
                    });

                    const paymentData = await response.json();

                    if (paymentData.status === 'success') {
                        ev.complete('success');
                        showErrorMessage('success', paymentData.message || 'Payment successful! Your device is now activated.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        ev.complete('fail');
                        showErrorMessage('error', paymentData.message || 'Payment failed. Please try again.');
                    }
                } catch (error) {
                    ev.complete('fail');
                    showErrorMessage('error', 'Payment failed. Please try again.');
                }
            });
        }
    }
</script>